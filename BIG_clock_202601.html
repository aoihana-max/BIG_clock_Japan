<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ä»Šæ—¥ã®æ—¥æ™‚</title>

<style>
:root{
  --bg:#000000;

  --year:#FFFFFF;

  --wk:#FFFF00;
  --sat:#5FB3E6;
  --sun:#FF4A4A;

  --time:#00ff00;

  --btn-bg:#ff8c00;
  --btn-bg-press:#C96A2C;
  --btn-ring:#C96A2C;
  --btn-disabled:#5A3A28;

  --btn-icon:#FFF1E6;
  --btn-icon-disabled:#D9B9A2;

  /* å¼·èª¿ï¼ˆæ‹¡å¤§ã®ã¿ï¼‰ */
  --dim-scale: 0.92;     /* å¼·èª¿ã—ã¦ã„ãªã„ã¨ãå°‘ã—å°ã•ã */
  --focus-scale: 1.18;   /* å¼·èª¿ã—ã¦ã„ã‚‹ã¨ãå¤§ãã */
}

/* layout */
html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  font-family:-apple-system,"BIZ UDPGothic","Meiryo",sans-serif;
  overflow:hidden;
}
.wrap{
  height:100%;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  gap:5vh;
  padding:24px;
  box-sizing:border-box;
}

/* text */
.yearline{
  color:var(--year);
  font-weight:900;
  font-size:clamp(64px,8vw,130px);
  white-space:nowrap;
}
.dateline{
  font-weight:950;
  font-size:clamp(126.5px,14.95vw,230px); /* 1.15å€ */
  white-space:nowrap;
}
.unit{ font-size:0.6em; margin:0; }

.timeRow{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:3vw;
  white-space:nowrap;
}
.timeline{
  color:var(--time);
  font-weight:950;
  font-size:clamp(126.5px,14.95vw,230px);
  white-space:nowrap;
}

/* weekday colors */
.wk{color:var(--wk);}
.sat{color:var(--sat);}
.sun{color:var(--sun);}

/* button */
.speakBtn{
  width:clamp(126px,12.6vw,198px);
  height:clamp(126px,12.6vw,198px);
  border-radius:9999px;

  border:6px solid var(--btn-ring);
  background:var(--btn-bg);
  color:var(--btn-icon);

  display:flex;
  align-items:center;
  justify-content:center;

  font-size:clamp(63px,6.3vw,108px);
  font-weight:900;

  box-shadow:0 10px 18px rgba(0,0,0,0.45);
  cursor:pointer;
}
.speakBtn:active{
  background:var(--btn-bg-press);
  transform:translateY(4px);
}
.speakBtn[disabled]{
  background:var(--btn-disabled);
  color:var(--btn-icon-disabled);
  border-color:#8C5A3C;
  box-shadow:none;
  cursor:default;
}

/* emphasis: scale only */
.emph{
  transition: transform 0.22s ease;
  transform: scale(var(--dim-scale));
}
.emph.focus{
  transform: scale(var(--focus-scale));
}
</style>
</head>

<body>
<div class="wrap">
  <div class="yearline emph" id="yearline">----</div>
  <div class="dateline emph" id="dateline">----</div>

  <div class="timeRow">
    <div class="timeline emph" id="timeline">--ï¼š--</div>
    <button class="speakBtn" id="speakBtn" onclick="manualSpeak()">ğŸ”Š</button>
  </div>
</div>

<script>
const yearEl = document.getElementById("yearline");
const dateEl = document.getElementById("dateline");
const timeEl = document.getElementById("timeline");
const speakBtn = document.getElementById("speakBtn");

const wd = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];

/* âœ… è‡ªå‹•èª­ã¿ä¸Šã’ï¼š7 / 12 / 18 */
const AUTO_HOURS = [7, 12, 18];

let speaking = false;
let lastAutoKey = "";

let userActivatedAudio = false;   // iOSå¯¾ç­–ï¼šä¸€åº¦ã§ã‚‚æ‰‹å‹•ã‚¿ãƒƒãƒ—ã—ãŸã‹
let audioCtx = null;             // WebAudioã¯ä½¿ã„å›ã™ï¼ˆå®‰å®šï¼‰

const pad = n => String(n).padStart(2,"0");
function dayClass(d){ return d===0 ? "sun" : d===6 ? "sat" : "wk"; }

/* ===== è¡¨ç¤ºæ›´æ–°ï¼ˆç©ºç™½ãŒå‡ºãªã„1è¡Œç‰ˆï¼‰ ===== */
function render(){
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth()+1;
  const d = now.getDate();
  const dow = now.getDay();

  yearEl.textContent = `ä»¤å’Œ${y-2018}å¹´ ${y}`;
  dateEl.innerHTML = `<span class="${dayClass(dow)}">${m}<span class="unit">æœˆ</span>${d}<span class="unit">æ—¥</span>(${wd[dow]})</span>`;
  timeEl.textContent = `${pad(now.getHours())}ï¼š${pad(now.getMinutes())}`;

  checkAutoSpeak(now);
}

/* ===== iOSå®‰å®šåŒ–ï¼šAudioContextã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§åˆæœŸåŒ– ===== */
function ensureAudioContext(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if(audioCtx.state === "suspended"){
    // iOSã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œä¸­ã« resume ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
    return audioCtx.resume().catch(()=>{});
  }
  return Promise.resolve();
}

/* ===== åŠ¹æœéŸ³ï¼ˆã¡ã‚ƒã‚‰ãƒ¼ã‚“ï¼‰â€»æ¯å›ã€ç›´å‰ã«é³´ã‚‰ã™ ===== */
function playChime(){
  // AudioContextãŒç”¨æ„ã§ããªã„çŠ¶æ³ï¼ˆæœªã‚¿ãƒƒãƒ—ç­‰ï¼‰ãªã‚‰ç„¡éŸ³ã§æŠœã‘ã‚‹
  if(!audioCtx) return Promise.resolve();

  const t = audioCtx.currentTime;
  const g = audioCtx.createGain();
  g.connect(audioCtx.destination);

  // å°‘ã—èã“ãˆã‚„ã™ã„éŸ³é‡
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.30, t + 0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.45);

  const o = audioCtx.createOscillator();
  o.type = "triangle";
  o.frequency.setValueAtTime(1200, t);
  o.frequency.exponentialRampToValueAtTime(600, t + 0.4);
  o.connect(g);

  o.start(t);
  o.stop(t + 0.45);

  // éŸ³ãŒé³´ã‚Šçµ‚ã‚ã‚‹ã¾ã§å¾…ã¤
  return new Promise(res => setTimeout(res, 470));
}

/* ===== å¼·èª¿åˆ‡ã‚Šæ›¿ãˆï¼ˆæ‹¡å¤§ã®ã¿ï¼‰ ===== */
function clearFocus(){
  yearEl.classList.remove("focus");
  dateEl.classList.remove("focus");
  timeEl.classList.remove("focus");
}
function focusDate(){ clearFocus(); dateEl.classList.add("focus"); }
function focusTime(){ clearFocus(); timeEl.classList.add("focus"); }
function focusYear(){ clearFocus(); yearEl.classList.add("focus"); }

/* ===== èª­ã¿ä¸Šã’æ–‡ï¼ˆ3åˆ†å‰²ï¼‰ ===== */
function timeGreeting(h){
  if(h===7)  return "æœã§ã™ã€‚";
  if(h===12) return "ãŠæ˜¼ã§ã™ã€‚";
  if(h===18) return "å¤•æ–¹ã§ã™ã€‚";
  return "";
}

function buildParts(now){
  const y = now.getFullYear();
  const m = now.getMonth()+1;
  const d = now.getDate();
  const dow = wd[now.getDay()];
  const h = now.getHours();
  const min = now.getMinutes();

  return {
    part1: `ä»Šæ—¥ã¯${m}æœˆ${d}æ—¥${dow}æ›œæ—¥ã§ã™ã€‚`,
    part2: `æ™‚åˆ»ã¯${h}æ™‚${min}åˆ†ã§ã™ã€‚`,
    part3: `ä»¤å’Œ${y-2018}å¹´ã€${y}å¹´ã§ã™ã€‚`
  };
}

function makeUtterance(text){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ja-JP";
  u.rate = 0.9;
  u.pitch = 1.2; // å¥³æ€§å¯„ã‚Šï¼ˆç«¯æœ«ä¾å­˜ï¼‰
  return u;
}

function speakUtterance(u){
  return new Promise((resolve) => {
    u.onend = resolve;
    u.onerror = resolve; // å¤±æ•—ã—ã¦ã‚‚å›ºã¾ã‚‰ãªã„
    speechSynthesis.speak(u);
  });
}

/* ===== 3æ®µéšï¼ˆåŠ¹æœéŸ³â†’èª­ã¿ä¸Šã’ï¼‰ã‚’é †ç•ªã«å®Ÿè¡Œ ===== */
async function speakSequence(now){
  if(speaking) return;
  speaking = true;
  speakBtn.disabled = true;

  const greet = timeGreeting(now.getHours());
  const { part1, part2, part3 } = buildParts(now);

  // iOSå¯¾ç­–ï¼šéŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³ã®åˆæœŸåŒ–ã§å¼•ã£ã‹ã‹ã‚Šã‚„ã™ã„ã®ã§ä¸€æ—¦cancel
  speechSynthesis.cancel();

  // â‘  ä»Šæ—¥ã¯â€¦ï¼ˆæ—¥ä»˜å¼·èª¿ï¼‰
  focusDate();
  await playChime();
  await speakUtterance(makeUtterance(greet + part1));

  // â‘¡ æ™‚åˆ»ã¯â€¦ï¼ˆæ™‚åˆ»å¼·èª¿ï¼‰
  focusTime();
  await playChime();
  await speakUtterance(makeUtterance(part2));

  // â‘¢ ä»¤å’Œâ€¦ï¼ˆå¹´å¼·èª¿ï¼‰
  focusYear();
  await playChime();
  await speakUtterance(makeUtterance(part3));

  clearFocus();
  speaking = false;
  speakBtn.disabled = false;
}

/* æ‰‹å‹•ï¼ˆæœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ AudioContext ã‚’ç¢ºå®Ÿã«èµ·å‹•ï¼‰ */
async function manualSpeak(){
  userActivatedAudio = true;
  await ensureAudioContext();
  await speakSequence(new Date());
}

/* è‡ªå‹•ï¼ˆ7/12/18æ™‚ã¡ã‚‡ã†ã©ï¼‰
   iOSå¯¾ç­–ï¼šä¸€åº¦ã§ã‚‚æ‰‹å‹•ã‚¿ãƒƒãƒ—ãŒãªã„ã¨è‡ªå‹•ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå®‰å®šé‡è¦–ï¼‰ */
function checkAutoSpeak(now){
  if(now.getMinutes() !== 0) return;
  if(!AUTO_HOURS.includes(now.getHours())) return;

  const key = `${now.toDateString()}-${now.getHours()}`;
  if(key === lastAutoKey) return;
  lastAutoKey = key;

  if(!userActivatedAudio) return; // âœ… ã“ã“ãŒå®‰å®šåŒ–ã®è¦
  // ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºä¸­ã§ãªã„ã¨ãã¯å®Ÿè¡Œã—ãªã„ï¼ˆä¸å…·åˆé˜²æ­¢ï¼‰
  if(document.visibilityState !== "visible") return;

  speakSequence(now);
}

/* åˆæœŸè¡¨ç¤º & åˆ†æ›´æ–°ï¼ˆåˆ†ãŒå¤‰ã‚ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«åˆã‚ã›ã¦æ›´æ–°ï¼‰ */
render();
(function tick(){
  const n = new Date();
  setTimeout(()=>{ render(); tick(); },
    (60-n.getSeconds())*1000 - n.getMilliseconds()+30);
})();
</script>
</body>
</html>
