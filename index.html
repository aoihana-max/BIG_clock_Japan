<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>BIG„Ç´„É¨„É≥„ÉÄ</title>

  <style>
    :root{
      --bg:#000000;

      --year:#FFFFFF;
      --wk:#FFFF00;
      --sat:#5FB3E6;
      --sun:#FF4A4A;

      --time:#00ff00;

      --btn-bg:#ff8c00;
      --btn-bg-press:#C96A2C;
      --btn-ring:#C96A2C;
      --btn-disabled:#5A3A28;
      --btn-icon:#FFF1E6;
      --btn-icon-disabled:#D9B9A2;

      /* Âº∑Ë™øÔºöÁô∫ÂÖâ„Å™„Åó„ÉªÊã°Â§ß„ÅÆ„Åø */
      --dim-scale: 0.92;
      --focus-scale: 1.18;

      /* JS„ÅßÊõ¥Êñ∞ÔºàÁ∏¶Ê®™Ëá™Âãï„Éï„Ç£„ÉÉ„ÉàÔºâ */
      --year-font: clamp(34px, 7.2vmin, 96px);
      --main-font: clamp(52px, 12.5vmin, 160px);
      --btn-size: clamp(76px, 10vmin, 138px);
      --btn-icon-size: clamp(40px, 6vmin, 76px);

      --dow-gap: 0.18em;
    }

    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      font-family:-apple-system,"BIZ UDPGothic","Meiryo",sans-serif;
      overflow:hidden;
    }

    .wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      padding: max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right))
               max(14px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));
      gap: 3.6vmin;
      box-sizing:border-box;
    }

    .yearline{
      color:var(--year);
      font-weight:900;
      font-size: var(--year-font);
      white-space:nowrap;
      max-width: 96vw;
    }

    .dateline{
      font-weight:950;
      font-size: var(--main-font);
      white-space:nowrap;
      max-width: 96vw;
    }

    .unit{ font-size:0.6em; margin:0; }
    .dow{ margin-left: var(--dow-gap); }

    .timeRow{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 3vmin;
      max-width: 96vw;
      white-space:nowrap;
    }
    @media (orientation: portrait){
      .timeRow{ flex-direction:column; gap: 2.2vmin; }
    }

    .timeline{
      color:var(--time);
      font-weight:950;
      font-size: var(--main-font);
      white-space:nowrap;
      max-width: 96vw;
    }

    .wk{color:var(--wk);}
    .sat{color:var(--sat);}
    .sun{color:var(--sun);}

    .speakBtn{
      width: var(--btn-size);
      height: var(--btn-size);
      border-radius:9999px;
      border: 5px solid var(--btn-ring);
      background: var(--btn-bg);
      color: var(--btn-icon);

      display:flex;
      align-items:center;
      justify-content:center;

      font-size: var(--btn-icon-size);
      font-weight:900;

      box-shadow:0 10px 18px rgba(0,0,0,0.45);

      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      cursor:pointer;
    }
    .speakBtn:active{ background: var(--btn-bg-press); transform: translateY(3px); }
    .speakBtn[disabled]{
      background: var(--btn-disabled);
      color: var(--btn-icon-disabled);
      border-color:#8C5A3C;
      box-shadow:none;
      cursor:default;
    }

    .emph{ transition: transform 0.22s ease; transform: scale(var(--dim-scale)); }
    .emph.focus{ transform: scale(var(--focus-scale)); }

    /* Ë®∫Êñ≠Ë°®Á§∫ÔºàÂ∞è„Åï„ÅèÔºâ */
    .diag{
      position: fixed;
      left: 10px;
      right: 10px;
      bottom: 10px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 10px 12px;
      color: #fff;
      font-size: 12px;
      line-height: 1.35;
      max-height: 22vh;
      overflow: auto;
      user-select: text;
    }
    .diag strong{ font-weight: 800; }
    .diag .row{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:6px; }
    .diag button{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color:#fff;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="yearline emph" id="yearline">----</div>
    <div class="dateline emph" id="dateline">----</div>

    <div class="timeRow">
      <div class="timeline emph" id="timeline">--Ôºö--</div>
      <button class="speakBtn" id="speakBtn" onclick="manualSpeak()" ontouchstart="manualSpeak()">üîä</button>
    </div>
  </div>

  <div class="diag" id="diag">
    <div class="row">
      <strong>Ë®∫Êñ≠</strong>
      <button onclick="testSpeech()">Èü≥Â£∞„ÉÜ„Çπ„Éà</button>
      <button onclick="refreshVoices()">Èü≥Â£∞‰∏ÄË¶ßÊõ¥Êñ∞</button>
    </div>
    <div id="diagText">Ëµ∑Âãï„Åó„Åæ„Åó„Åü„ÄÇ</div>
  </div>

<script>
  const yearEl = document.getElementById("yearline");
  const dateEl = document.getElementById("dateline");
  const timeEl = document.getElementById("timeline");
  const speakBtn = document.getElementById("speakBtn");
  const diagText = document.getElementById("diagText");

  const wd = ["Êó•","Êúà","ÁÅ´","Ê∞¥","Êú®","Èáë","Âúü"];
  const AUTO_HOURS = [7, 12, 18];

  let speaking = false;
  let lastAutoKey = "";

  let userActivatedAudio = false;
  let audioCtx = null;

  // Speech voices
  let cachedVoices = [];
  let preferredVoice = null;

  const pad = n => String(n).padStart(2,"0");
  function dayClass(d){ return d===0 ? "sun" : d===6 ? "sat" : "wk"; }

  function log(msg){
    const t = new Date();
    const stamp = `${pad(t.getHours())}:${pad(t.getMinutes())}:${pad(t.getSeconds())}`;
    diagText.innerHTML = `${stamp} ${msg}<br>` + diagText.innerHTML;
  }

  function updateLayoutVars(){
    const w = window.innerWidth;
    const h = window.innerHeight;
    const vmin = Math.min(w, h);
    const isLandscape = w > h;
    const mult = isLandscape ? 1.2 : 1.0; // ‚Üê Ê®™Âêë„Åç„ÅØÂÖ®‰Ωì1.2ÂÄç

    const yearMin = Math.max(28, Math.floor(vmin * 0.085 * mult));
    const yearPref = (vmin * 0.11 * mult).toFixed(2) + "px";
    const yearMax = Math.max(72, Math.floor(vmin * 0.20 * mult));

    const mainMin = Math.max(40, Math.floor(vmin * 0.13 * mult));
    const mainPref = (vmin * 0.19 * mult).toFixed(2) + "px";
    const mainMax = Math.max(110, Math.floor(vmin * 0.34 * mult));

    const btnMin = Math.max(60, Math.floor(vmin * 0.14 * mult));
    const btnPref = Math.max(72, Math.floor(vmin * 0.16 * mult));
    const btnMax = Math.max(110, Math.floor(vmin * 0.22 * mult));

    const iconMin = Math.max(32, Math.floor(vmin * 0.085 * mult));
    const iconPref = Math.max(40, Math.floor(vmin * 0.095 * mult));
    const iconMax = Math.max(64, Math.floor(vmin * 0.13 * mult));

    const root = document.documentElement.style;
    root.setProperty("--year-font", `clamp(${yearMin}px, ${yearPref}, ${yearMax}px)`);
    root.setProperty("--main-font", `clamp(${mainMin}px, ${mainPref}, ${mainMax}px)`);
    root.setProperty("--btn-size", `clamp(${btnMin}px, ${btnPref}px, ${btnMax}px)`);
    root.setProperty("--btn-icon-size", `clamp(${iconMin}px, ${iconPref}px, ${iconMax}px)`);
  }
  window.addEventListener("resize", updateLayoutVars);
  window.addEventListener("orientationchange", updateLayoutVars);

  function render(){
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth()+1;
    const d = now.getDate();
    const dow = now.getDay();

    yearEl.textContent = `‰ª§Âíå${y-2018}Âπ¥ ${y}`;
    dateEl.innerHTML =
      `<span class="${dayClass(dow)}">${m}<span class="unit">Êúà</span>${d}<span class="unit">Êó•</span><span class="dow">(${wd[dow]})</span></span>`;
    timeEl.textContent = `${pad(now.getHours())}Ôºö${pad(now.getMinutes())}`;

    checkAutoSpeak(now);
  }

  function ensureAudioContext(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      log("AudioContext ‰ΩúÊàê");
    }
    if(audioCtx.state === "suspended"){
      log("AudioContext resume Ë©¶Ë°å");
      return audioCtx.resume().catch(()=>{ log("AudioContext resume Â§±Êïó"); });
    }
    return Promise.resolve();
  }

  function playChime(){
    if(!audioCtx) return Promise.resolve();

    const t = audioCtx.currentTime;
    const g = audioCtx.createGain();
    g.connect(audioCtx.destination);

    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(0.30,t+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,t+0.45);

    const o = audioCtx.createOscillator();
    o.type="triangle";
    o.frequency.setValueAtTime(1200,t);
    o.frequency.exponentialRampToValueAtTime(600,t+0.4);
    o.connect(g);

    o.start(t);
    o.stop(t+0.45);

    return new Promise(res => setTimeout(res, 470));
  }

  function clearFocus(){
    yearEl.classList.remove("focus");
    dateEl.classList.remove("focus");
    timeEl.classList.remove("focus");
  }
  function focusDate(){ clearFocus(); dateEl.classList.add("focus"); }
  function focusTime(){ clearFocus(); timeEl.classList.add("focus"); }
  function focusYear(){ clearFocus(); yearEl.classList.add("focus"); }

  function timeGreeting(h){
    if(h===7)  return "Êúù„Åß„Åô„ÄÇ";
    if(h===12) return "„ÅäÊòº„Åß„Åô„ÄÇ";
    if(h===18) return "Â§ïÊñπ„Åß„Åô„ÄÇ";
    return "";
  }

  function buildParts(now){
    const y = now.getFullYear();
    const m = now.getMonth()+1;
    const d = now.getDate();
    const dow = wd[now.getDay()];
    const h = now.getHours();
    const min = now.getMinutes();
    return {
      part1: `‰ªäÊó•„ÅØ${m}Êúà${d}Êó•${dow}ÊõúÊó•„Åß„Åô„ÄÇ`,
      part2: `ÊôÇÂàª„ÅØ${h}ÊôÇ${min}ÂàÜ„Åß„Åô„ÄÇ`,
      part3: `‰ª§Âíå${y-2018}Âπ¥„ÄÅ${y}Âπ¥„Åß„Åô„ÄÇ`
    };
  }

  function refreshVoices(){
    if(!("speechSynthesis" in window)){
      log("speechSynthesis „Å™„ÅóÔºà„Åì„ÅÆÁí∞Â¢É„Åß„ÅØÈü≥Â£∞‰∏çÂèØÔºâ");
      return;
    }
    cachedVoices = speechSynthesis.getVoices() || [];
    const ja = cachedVoices.filter(v => (v.lang || "").toLowerCase().startsWith("ja"));
    preferredVoice = ja[0] || null;
    log(`Èü≥Â£∞‰∏ÄË¶ß: total=${cachedVoices.length}, ja=${ja.length}${preferredVoice ? " / ja[0]="+preferredVoice.name : ""}`);
  }

  // voices „ÅåÈÅÖ„Çå„Å¶ÂÖ•„ÇãiOSÂØæÁ≠ñ
  if("speechSynthesis" in window){
    speechSynthesis.onvoiceschanged = () => {
      refreshVoices();
    };
  }

  function makeUtterance(text){
    const u = new SpeechSynthesisUtterance(text);
    u.lang="ja-JP";
    u.rate=0.9;
    u.pitch=1.2;
    u.volume=1;
    // iOS„ÅßvoiceÊú™ÊåáÂÆö„Å†„Å®ÁÑ°Èü≥„Å´„Å™„Çã„Åì„Å®„Åå„ÅÇ„Çã„ÅÆ„Åß„ÄÅÂèñ„Çå„Åü„ÇâÊåáÂÆö
    if(preferredVoice) u.voice = preferredVoice;
    return u;
  }

  // ‚úÖ iOSÊúÄÈáçË¶ÅÔºöÁô∫Ë©±ÈñãÂßã„Åß„Åç„Å™„ÅÑ/„Ç§„Éô„É≥„Éà„ÅåËøî„Çâ„Å™„ÅÑÊôÇ„Å´ÂøÖ„ÅöÊ¨°„Å∏ÈÄ≤„ÇÄ
  function speakUtteranceSafe(u, fallbackMs = 6500){
    return new Promise(resolve=>{
      let finished = false;
      const finish = (why) => {
        if(finished) return;
        finished = true;
        if(why) log(why);
        resolve();
      };

      u.onstart = () => log("TTS start");
      u.onend = () => finish("TTS end");
      u.onerror = () => finish("TTS error");

      // ÊúÄÁµÇ„Çø„Ç§„É†„Ç¢„Ç¶„Éà
      const timer = setTimeout(() => finish("TTS timeoutÔºàÁÑ°Èü≥/ÁÑ°ÂèçÂøú„ÅÆÂèØËÉΩÊÄßÔºâ"), fallbackMs);

      // Áô∫Ë©±ÈñãÂßã„Çí„Åß„Åç„Çã„Å†„ÅëÁ¢∫ÂÆü„Å´
      try { speechSynthesis.cancel(); } catch(e) {}
      try { speechSynthesis.resume(); } catch(e) {}

      // iOS„Åß„Äå„Åô„Åê speak„Äç„Åô„Çã„Å®Â§±Êïó„Åó„ÇÑ„Åô„ÅÑ„ÅÆ„ÅßÂ∞ë„ÅóÂæÖ„Å§
      setTimeout(() => {
        try { speechSynthesis.resume(); } catch(e) {}
        try { speechSynthesis.speak(u); } catch(e) { finish("TTS speak throw"); }
      }, 180);

      // finish„Åó„Åü„Çâ„Çø„Ç§„Éû„ÉºËß£Èô§
      const origResolve = resolve;
      resolve = () => { clearTimeout(timer); origResolve(); };
    });
  }

  async function speakSequence(now){
    if(speaking) return;
    speaking = true;
    speakBtn.disabled = true;

    try{
      if(!("speechSynthesis" in window)){
        log("speechSynthesis „Åå‰Ωø„Åà„Åæ„Åõ„Çì");
        return;
      }

      // voicesÊõ¥Êñ∞ÔºàÈÅÖÂª∂„É≠„Éº„ÉâÂØæÁ≠ñÔºâ
      refreshVoices();

      const greet = timeGreeting(now.getHours());
      const { part1, part2, part3 } = buildParts(now);

      focusDate(); await playChime(); await speakUtteranceSafe(makeUtterance(greet + part1), 7500);
      focusTime(); await playChime(); await speakUtteranceSafe(makeUtterance(part2), 6500);
      focusYear(); await playChime(); await speakUtteranceSafe(makeUtterance(part3), 6500);

    } finally {
      clearFocus();
      speaking = false;
      speakBtn.disabled = false;
    }
  }

  async function manualSpeak(){
    if(speaking) return;
    userActivatedAudio = true;

    await ensureAudioContext();

    refreshVoices();
    log("ÊâãÂãïË™≠„Åø‰∏ä„ÅíÈñãÂßã");
    await speakSequence(new Date());
  }

  function checkAutoSpeak(now){
    if(now.getMinutes() !== 0) return;
    if(!AUTO_HOURS.includes(now.getHours())) return;

    const key = `${now.toDateString()}-${now.getHours()}`;
    if(key === lastAutoKey) return;
    lastAutoKey = key;

    if(!userActivatedAudio) return;
    if(document.visibilityState !== "visible") return;

    speakSequence(now);
  }

  async function testSpeech(){
    userActivatedAudio = true;
    await ensureAudioContext();

    refreshVoices();
    log("Èü≥Â£∞„ÉÜ„Çπ„ÉàÔºöÈñãÂßãÔºà„Äé„ÉÜ„Çπ„Éà„Åß„Åô„ÄèÔºâ");
    try{
      // ÂäπÊûúÈü≥„Å™„Åó„ÅßÂçòÁô∫„ÉÜ„Çπ„Éà
      await speakUtteranceSafe(makeUtterance("„ÉÜ„Çπ„Éà„Åß„Åô„ÄÇ"), 4500);
    } finally {
      log("Èü≥Â£∞„ÉÜ„Çπ„ÉàÔºöÁµÇ‰∫Ü");
    }
  }

  updateLayoutVars();
  render();
  refreshVoices();

  (function tick(){
    const n = new Date();
    setTimeout(()=>{ render(); tick(); },
      (60-n.getSeconds())*1000 - n.getMilliseconds()+30);
  })();
</script>
</body>
</html>
