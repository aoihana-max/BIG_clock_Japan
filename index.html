<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>BIGã‚«ãƒ¬ãƒ³ãƒ€</title>

  <style>
    :root{
      --bg:#000000;

      --year:#FFFFFF;
      --wk:#FFFF00;
      --sat:#5FB3E6;
      --sun:#FF4A4A;
      --time:#00ff00;

      --btn-bg:#ff8c00;
      --btn-bg-press:#C96A2C;
      --btn-ring:#C96A2C;
      --btn-disabled:#5A3A28;
      --btn-icon:#FFF1E6;
      --btn-icon-disabled:#D9B9A2;

      /* å¼·èª¿ï¼šç™ºå…‰ãªã—ãƒ»æ‹¡å¤§ã®ã¿ */
      --dim-scale: 0.92;
      --focus-scale: 1.18;

      /* JSã§æ›´æ–°ï¼ˆç¸¦æ¨ªè‡ªå‹•ãƒ•ã‚£ãƒƒãƒˆï¼‰ */
      --year-font: clamp(34px, 7.2vmin, 96px);
      --main-font: clamp(52px, 12.5vmin, 160px);
      --btn-size: clamp(76px, 10vmin, 138px);
      --btn-icon-size: clamp(40px, 6vmin, 76px);

      /* (æœˆ) ã‚’å°‘ã—é›¢ã™ */
      --dow-gap: 0.18em;
    }

    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      font-family:-apple-system,"BIZ UDPGothic","Meiryo",sans-serif;
      overflow:hidden;
    }

    .wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      padding: max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right))
               max(14px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));
      gap: 3.6vmin;
      box-sizing:border-box;
    }

    .yearline{
      color:var(--year);
      font-weight:900;
      font-size: var(--year-font);
      white-space:nowrap;
      max-width: 96vw;
    }

    .dateline{
      font-weight:950;
      font-size: var(--main-font);
      white-space:nowrap;
      max-width: 96vw;
    }

    .unit{ font-size:0.6em; margin:0; }
    .dow{ margin-left: var(--dow-gap); }

    .timeRow{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 3vmin;
      max-width: 96vw;
      white-space:nowrap;
    }

    @media (orientation: portrait){
      .timeRow{
        flex-direction:column;
        gap: 2.2vmin;
      }
    }

    .timeline{
      color:var(--time);
      font-weight:950;
      font-size: var(--main-font);
      white-space:nowrap;
      max-width: 96vw;
    }

    .wk{color:var(--wk);}
    .sat{color:var(--sat);}
    .sun{color:var(--sun);}

    .speakBtn{
      width: var(--btn-size);
      height: var(--btn-size);
      border-radius:9999px;
      border: 5px solid var(--btn-ring);
      background: var(--btn-bg);
      color: var(--btn-icon);

      display:flex;
      align-items:center;
      justify-content:center;

      font-size: var(--btn-icon-size);
      font-weight:900;

      box-shadow:0 10px 18px rgba(0,0,0,0.45);

      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      cursor:pointer;
    }

    .speakBtn:active{
      background: var(--btn-bg-press);
      transform: translateY(3px);
    }

    .speakBtn[disabled]{
      background: var(--btn-disabled);
      color: var(--btn-icon-disabled);
      border-color:#8C5A3C;
      box-shadow:none;
      cursor:default;
    }

    /* å¼·èª¿ï¼ˆæ‹¡å¤§ã®ã¿ï¼‰ */
    .emph{
      transition: transform 0.22s ease;
      transform: scale(var(--dim-scale));
    }
    .emph.focus{
      transform: scale(var(--focus-scale));
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="yearline emph" id="yearline">----</div>
    <div class="dateline emph" id="dateline">----</div>

    <div class="timeRow">
      <div class="timeline emph" id="timeline">--ï¼š--</div>
      <button class="speakBtn" id="speakBtn" onclick="manualSpeak()" ontouchstart="manualSpeak()">ğŸ”Š</button>
    </div>
  </div>

<script>
  const yearEl = document.getElementById("yearline");
  const dateEl = document.getElementById("dateline");
  const timeEl = document.getElementById("timeline");
  const speakBtn = document.getElementById("speakBtn");

  const wd = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];

  /* è‡ªå‹•èª­ã¿ä¸Šã’ï¼š7 / 12 / 18 */
  const AUTO_HOURS = [7, 12, 18];

  let speaking = false;
  let lastAutoKey = "";

  /* iOSå®‰å®šåŒ–ï¼šåˆå›ã‚¿ãƒƒãƒ—å¾Œã«è‡ªå‹•ã‚’è¨±å¯ */
  let userActivatedAudio = false;
  let audioCtx = null;

  const pad = n => String(n).padStart(2,"0");
  function dayClass(d){ return d===0 ? "sun" : d===6 ? "sat" : "wk"; }

  /* ç«¯æœ«ãƒ»å‘ãã«åˆã‚ã›ã¦ãƒ•ã‚©ãƒ³ãƒˆã‚’è‡ªå‹•èª¿æ•´ */
  function updateLayoutVars(){
    const w = window.innerWidth;
    const h = window.innerHeight;
    const vmin = Math.min(w, h);

    const yearMin = Math.max(28, Math.floor(vmin * 0.085));
    const yearPref = (vmin * 0.11).toFixed(2) + "px";
    const yearMax = Math.max(72, Math.floor(vmin * 0.20));

    const mainMin = Math.max(40, Math.floor(vmin * 0.13));
    const mainPref = (vmin * 0.19).toFixed(2) + "px";
    const mainMax = Math.max(110, Math.floor(vmin * 0.34));

    const btnMin = Math.max(60, Math.floor(vmin * 0.14));
    const btnPref = Math.max(72, Math.floor(vmin * 0.16));
    const btnMax = Math.max(110, Math.floor(vmin * 0.22));

    const iconMin = Math.max(32, Math.floor(vmin * 0.085));
    const iconPref = Math.max(40, Math.floor(vmin * 0.095));
    const iconMax = Math.max(64, Math.floor(vmin * 0.13));

    const root = document.documentElement.style;
    root.setProperty("--year-font", `clamp(${yearMin}px, ${yearPref}, ${yearMax}px)`);
    root.setProperty("--main-font", `clamp(${mainMin}px, ${mainPref}, ${mainMax}px)`);
    root.setProperty("--btn-size", `clamp(${btnMin}px, ${btnPref}px, ${btnMax}px)`);
    root.setProperty("--btn-icon-size", `clamp(${iconMin}px, ${iconPref}px, ${iconMax}px)`);
  }
  window.addEventListener("resize", updateLayoutVars);
  window.addEventListener("orientationchange", updateLayoutVars);

  /* è¡¨ç¤ºæ›´æ–°ï¼ˆç©ºç™½ãŒå‡ºãªã„1è¡Œ + (æœˆ)ã ã‘å°‘ã—é›¢ã™ï¼‰ */
  function render(){
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth()+1;
    const d = now.getDate();
    const dow = now.getDay();

    yearEl.textContent = `ä»¤å’Œ${y-2018}å¹´ ${y}`;
    dateEl.innerHTML =
      `<span class="${dayClass(dow)}">${m}<span class="unit">æœˆ</span>${d}<span class="unit">æ—¥</span><span class="dow">(${wd[dow]})</span></span>`;
    timeEl.textContent = `${pad(now.getHours())}ï¼š${pad(now.getMinutes())}`;

    checkAutoSpeak(now);
  }

  /* AudioContextï¼ˆæ‰‹å‹•ã‚¿ãƒƒãƒ—ã§èµ·å‹•ï¼‰ */
  function ensureAudioContext(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === "suspended"){
      return audioCtx.resume().catch(()=>{});
    }
    return Promise.resolve();
  }

  /* åŠ¹æœéŸ³ï¼ˆå„ãƒ‘ãƒ¼ãƒˆç›´å‰ï¼‰ */
  function playChime(){
    if(!audioCtx) return Promise.resolve();

    const t = audioCtx.currentTime;
    const g = audioCtx.createGain();
    g.connect(audioCtx.destination);

    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(0.30,t+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,t+0.45);

    const o = audioCtx.createOscillator();
    o.type="triangle";
    o.frequency.setValueAtTime(1200,t);
    o.frequency.exponentialRampToValueAtTime(600,t+0.4);
    o.connect(g);

    o.start(t);
    o.stop(t+0.45);

    return new Promise(res => setTimeout(res, 470));
  }

  /* å¼·èª¿ï¼ˆæ‹¡å¤§ã®ã¿ï¼‰ */
  function clearFocus(){
    yearEl.classList.remove("focus");
    dateEl.classList.remove("focus");
    timeEl.classList.remove("focus");
  }
  function focusDate(){ clearFocus(); dateEl.classList.add("focus"); }
  function focusTime(){ clearFocus(); timeEl.classList.add("focus"); }
  function focusYear(){ clearFocus(); yearEl.classList.add("focus"); }

  /* èª­ã¿ä¸Šã’æ–‡ï¼ˆ3åˆ†å‰²ï¼‰ */
  function timeGreeting(h){
    if(h===7)  return "æœã§ã™ã€‚";
    if(h===12) return "ãŠæ˜¼ã§ã™ã€‚";
    if(h===18) return "å¤•æ–¹ã§ã™ã€‚";
    return "";
  }

  function buildParts(now){
    const y = now.getFullYear();
    const m = now.getMonth()+1;
    const d = now.getDate();
    const dow = wd[now.getDay()];
    const h = now.getHours();
    const min = now.getMinutes();
    return {
      part1: `ä»Šæ—¥ã¯${m}æœˆ${d}æ—¥${dow}æ›œæ—¥ã§ã™ã€‚`,
      part2: `æ™‚åˆ»ã¯${h}æ™‚${min}åˆ†ã§ã™ã€‚`,
      part3: `ä»¤å’Œ${y-2018}å¹´ã€${y}å¹´ã§ã™ã€‚`
    };
  }

  function makeUtterance(text){
    const u = new SpeechSynthesisUtterance(text);
    u.lang="ja-JP";
    u.rate=0.9;
    u.pitch=1.2;
    return u;
  }

  /* âœ… iOSä¿é™ºï¼šonend/onerrorãŒæ¥ãªã„ã“ã¨ãŒã‚ã‚‹ã®ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§å¿…ãšresolve */
  function speakUtterance(u, fallbackMs = 4500){
    return new Promise(resolve=>{
      let done = false;
      const finish = () => {
        if(done) return;
        done = true;
        resolve();
      };
      u.onend = finish;
      u.onerror = finish;
      speechSynthesis.speak(u);
      setTimeout(finish, fallbackMs);
    });
  }

  /* âœ… å®Œå…¨åŒæœŸï¼šå¼·èª¿ â†’ åŠ¹æœéŸ³ â†’ èª­ã¿ä¸Šã’ï¼ˆãƒ‘ãƒ¼ãƒˆã”ã¨ï¼‰ */
  async function speakSequence(now){
    if(speaking) return;
    speaking = true;
    speakBtn.disabled = true;

    try{
      speechSynthesis.cancel();

      const greet = timeGreeting(now.getHours());
      const { part1, part2, part3 } = buildParts(now);

      // â‘  æ—¥ä»˜
      focusDate();
      await playChime();
      await speakUtterance(makeUtterance(greet + part1), 5200);

      // â‘¡ æ™‚åˆ»
      focusTime();
      await playChime();
      await speakUtterance(makeUtterance(part2), 4200);

      // â‘¢ å¹´
      focusYear();
      await playChime();
      await speakUtterance(makeUtterance(part3), 4200);

    } finally {
      clearFocus();
      speaking = false;
      speakBtn.disabled = false;
    }
  }

  /* æ‰‹å‹• */
  async function manualSpeak(){
    if(speaking) return;
    userActivatedAudio = true;
    await ensureAudioContext();
    await speakSequence(new Date());
  }

  /* è‡ªå‹•ï¼ˆ7/12/18ï¼‰â€»åˆå›ã‚¿ãƒƒãƒ—å¾Œã®ã¿ï¼ç”»é¢è¡¨ç¤ºä¸­ã®ã¿ */
  function checkAutoSpeak(now){
    if(now.getMinutes() !== 0) return;
    if(!AUTO_HOURS.includes(now.getHours())) return;

    const key = `${now.toDateString()}-${now.getHours()}`;
    if(key === lastAutoKey) return;
    lastAutoKey = key;

    if(!userActivatedAudio) return;
    if(document.visibilityState !== "visible") return;

    speakSequence(now);
  }

  /* åˆæœŸåŒ– */
  updateLayoutVars();
  render();

  /* åˆ†ãŒå¤‰ã‚ã‚‹ç¬é–“ã«æ›´æ–° */
  (function tick(){
    const n = new Date();
    setTimeout(()=>{ render(); tick(); },
      (60-n.getSeconds())*1000 - n.getMilliseconds()+30);
  })();
</script>
</body>
</html>
