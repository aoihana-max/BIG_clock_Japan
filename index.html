<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>BIGã‚«ãƒ¬ãƒ³ãƒ€</title>

  <style>
    :root{
      --bg:#000000;

      --year:#FFFFFF;

      --wk:#FFFF00;
      --sat:#5FB3E6;
      --sun:#FF4A4A;

      --time:#00ff00;

      --btn-bg:#ff8c00;
      --btn-bg-press:#C96A2C;
      --btn-ring:#C96A2C;
      --btn-disabled:#5A3A28;

      --btn-icon:#FFF1E6;
      --btn-icon-disabled:#D9B9A2;

      /* å¼·èª¿ï¼šæ‹¡å¤§ã®ã¿ */
      --dim-scale: 0.92;
      --focus-scale: 1.18;

      /* (æœˆ)ã‚’å°‘ã—é›¢ã™ */
      --dow-gap: 0.18em;

      /* âœ… æ–‡å­—ã‚µã‚¤ã‚ºã®æŒ‡å®šï¼ˆJSã§è‡ªå‹•èª¿æ•´ï¼‰ */
      --year-font: clamp(34px, 7.2vmin, 96px);
      --main-font: clamp(52px, 12.5vmin, 160px);
      --btn-size: clamp(76px, 10vmin, 138px);
      --btn-icon-size: clamp(40px, 6vmin, 76px);

      /* âœ… æœˆ/æ—¥ ã¨ æ‹¬å¼§ï¼ˆ ï¼‰ã®ã‚µã‚¤ã‚º */
      --unit-scale: 0.8;      /* æœˆãƒ»æ—¥ï¼š0.8å€ */
      --paren-scale: 0.8;     /* ï¼ˆ ï¼‰ï¼š0.8å€ï¼ˆunitã¨åŒã˜ï¼‰ */
    }

    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      font-family:-apple-system,"BIZ UDPGothic","Meiryo",sans-serif;
      overflow:hidden;
    }

    .wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      padding: max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right))
               max(14px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));
      gap: 3.6vmin;
      box-sizing:border-box;
    }

    /* --- ãƒ†ã‚¹ãƒˆï¼ˆã‚¹ã‚¤ãƒƒãƒONï¼‰ç”»é¢ --- */
    .gate{
      position:fixed;
      inset:0;
      background:var(--bg);
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap: 4vmin;
      padding: max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right))
               max(14px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));
      box-sizing:border-box;
      z-index: 9999;
    }
    .gateTitle{
      color: var(--year);
      font-weight: 900;
      font-size: clamp(30px, 5.2vmin, 54px);
      opacity: 0.95;
    }
    .gateBtn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 0.4em;
      padding: 18px 26px;
      border-radius: 22px;
      border: 3px solid rgba(255,255,255,0.18);
      background: rgba(255,140,0,0.92);
      color:#fff;
      font-weight: 900;
      font-size: clamp(26px, 6vmin, 52px);
      box-shadow: 0 12px 22px rgba(0,0,0,0.55);
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      cursor:pointer;
    }
    .gateBtn:active{ transform: translateY(3px); background: rgba(201,106,44,0.95); }
    .gateHint{
      color: rgba(255,255,255,0.78);
      font-size: clamp(14px, 3.2vmin, 22px);
      text-align:center;
      max-width: 38em;
      line-height: 1.35;
    }

    /* --- æœ¬ä½“è¡¨ç¤º --- */
    .yearline{
      color:var(--year);
      font-weight:900;
      font-size: var(--year-font);
      white-space:nowrap;
      max-width: 96vw;
    }

    .dateline{
      font-weight:950;
      font-size: var(--main-font);
      max-width: 96vw;

      /* ã¯ã¿å‡ºã—å¯¾ç­–ï¼šå¿…è¦ãªã‚‰æ”¹è¡Œã§ãã‚‹ã‚ˆã†ã« */
      white-space: normal;
      overflow-wrap: anywhere;
    }

    .timeRow{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 3vmin;
      max-width: 96vw;
      white-space:nowrap;
    }
    @media (orientation: portrait){
      .timeRow{ flex-direction:column; gap: 2.2vmin; }
    }

    /* æ™‚åˆ»ï¼æ—¥ä»˜ã¨åŒã‚µã‚¤ã‚º */
    .timeline{
      color:var(--time);
      font-weight:950;
      font-size: var(--main-font);
      white-space:nowrap;
      max-width: 96vw;
    }

    .wk{color:var(--wk);}
    .sat{color:var(--sat);}
    .sun{color:var(--sun);}

    /* éŸ³å£°ãƒœã‚¿ãƒ³ */
    .speakBtn{
      width: var(--btn-size);
      height: var(--btn-size);
      border-radius:9999px;

      border: 5px solid var(--btn-ring);
      background: var(--btn-bg);
      color: var(--btn-icon);

      display:flex;
      align-items:center;
      justify-content:center;

      font-size: var(--btn-icon-size);
      font-weight:900;

      box-shadow:0 10px 18px rgba(0,0,0,0.45);

      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      cursor:pointer;
    }
    .speakBtn:active{ background: var(--btn-bg-press); transform: translateY(3px); }
    .speakBtn[disabled]{
      background: var(--btn-disabled);
      color: var(--btn-icon-disabled);
      border-color:#8C5A3C;
      box-shadow:none;
      cursor:default;
    }

    /* âœ… å¼·èª¿ï¼ˆæ‹¡å¤§ã®ã¿ï¼‰ */
    .emph{
      transition: transform 0.22s ease;
      transform: scale(var(--dim-scale));
    }
    .emph.focus{
      transform: scale(var(--focus-scale));
    }

    /* æ—¥ä»˜å†…ãƒ‘ãƒ¼ãƒ„ï¼ˆå¼·èª¿åˆ†å‰²ç”¨ï¼‰ */
    .dateMain, .dateWeek{
      display:inline-block; /* transformãŒåŠ¹ãã‚ˆã†ã« */
    }

    /* æœˆ/æ—¥ ã ã‘ 0.8å€ */
    .unit{
      display:inline-block;
      transform: scale(var(--unit-scale));
      transform-origin: left center;
      margin: 0 0.02em;
    }

    /* ï¼ˆ ï¼‰ã ã‘ 0.8å€ï¼ˆunitã¨åŒã˜ï¼‰ */
    .paren{
      display:inline-block;
      transform: scale(var(--paren-scale));
      transform-origin: center;
    }

    .dowGap{
      margin-left: var(--dow-gap);
    }
  </style>
</head>

<body>
  <!-- èµ·å‹•ã‚²ãƒ¼ãƒˆï¼ˆã‚¹ã‚¤ãƒƒãƒONï¼‰ -->
  <div class="gate" id="gate">
    <div class="gateTitle">âœ¨ BIGã‚«ãƒ¬ãƒ³ãƒ€</div>
    <button class="gateBtn" id="gateBtn" onclick="runGate()" ontouchstart="runGate()">âœ¨ ã‚¹ã‚¤ãƒƒãƒON</button>
    <div class="gateHint">æœ€åˆã«ä¸€åº¦ã ã‘æŠ¼ã—ã¦ãã ã•ã„ã€‚éŸ³å£°ãŒä½¿ãˆã‚‹çŠ¶æ…‹ã«ã—ã¦ã‹ã‚‰ã€ã‚«ãƒ¬ãƒ³ãƒ€ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</div>
  </div>

  <!-- æœ¬ä½“ -->
  <div class="wrap" id="app" style="visibility:hidden;">
    <div class="yearline emph" id="yearline">----</div>
    <div class="dateline emph" id="dateline">----</div>

    <div class="timeRow">
      <div class="timeline emph" id="timeline">--ï¼š--</div>
      <button class="speakBtn" id="speakBtn" onclick="manualSpeak()" ontouchstart="manualSpeak()">ğŸ”Š</button>
    </div>
  </div>

<script>
  const gate = document.getElementById("gate");
  const gateBtn = document.getElementById("gateBtn");
  const app = document.getElementById("app");

  const yearEl = document.getElementById("yearline");
  const dateEl = document.getElementById("dateline");
  const timeEl = document.getElementById("timeline");
  const speakBtn = document.getElementById("speakBtn");

  const wd = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  const AUTO_HOURS = [7, 12, 18];

  let speaking = false;
  let lastAutoKey = "";

  // iOSå®‰å®šåŒ–ï¼šåˆå›ã®ã‚²ãƒ¼ãƒˆæˆåŠŸå¾Œã«è‡ªå‹•èª­ã¿ä¸Šã’ã‚’è¨±å¯
  let ttsReady = false;

  // WebAudioï¼ˆåŠ¹æœéŸ³ï¼‰
  let audioCtx = null;

  // voice
  let preferredVoice = null;

  const pad = n => String(n).padStart(2,"0");
  function dayClass(d){ return d===0 ? "sun" : d===6 ? "sat" : "wk"; }

  // âœ… ç”»é¢ã«åã‚ã‚‹ï¼šè¦ç´ ã®æ¨ªå¹…ãŒã¯ã¿å‡ºã—ãŸã‚‰ç¸®å°ï¼ˆæœ€å¤§ 1 â†’ æœ€å° 0.78ï¼‰
  function fitToWidth(el, minScale = 0.78){
    const parent = el.parentElement;
    if(!parent) return;

    // ã„ã£ãŸã‚“æˆ»ã™
    el.style.transform = "";

    const maxW = parent.clientWidth * 0.98;
    const w = el.scrollWidth;

    if(w > maxW){
      const scale = Math.max(minScale, maxW / w);
      el.style.transformOrigin = "center";
      el.style.transform = `scale(${scale})`;
    }
  }

  // âœ… æ¨ªå‘ãã¯å…¨ä½“1.2å€
  function updateLayoutVars(){
    const w = window.innerWidth;
    const h = window.innerHeight;
    const vmin = Math.min(w, h);
    const isLandscape = w > h;
    const mult = isLandscape ? 1.2 : 1.0;

    const yearMin = Math.max(28, Math.floor(vmin * 0.085 * mult));
    const yearPref = (vmin * 0.11 * mult).toFixed(2) + "px";
    const yearMax = Math.max(72, Math.floor(vmin * 0.20 * mult));

    const mainMin = Math.max(40, Math.floor(vmin * 0.13 * mult));
    const mainPref = (vmin * 0.19 * mult).toFixed(2) + "px";
    const mainMax = Math.max(110, Math.floor(vmin * 0.34 * mult));

    const btnMin = Math.max(60, Math.floor(vmin * 0.14 * mult));
    const btnPref = Math.max(72, Math.floor(vmin * 0.16 * mult));
    const btnMax = Math.max(110, Math.floor(vmin * 0.22 * mult));

    const iconMin = Math.max(32, Math.floor(vmin * 0.085 * mult));
    const iconPref = Math.max(40, Math.floor(vmin * 0.095 * mult));
    const iconMax = Math.max(64, Math.floor(vmin * 0.13 * mult));

    const root = document.documentElement.style;
    root.setProperty("--year-font", `clamp(${yearMin}px, ${yearPref}, ${yearMax}px)`);
    root.setProperty("--main-font", `clamp(${mainMin}px, ${mainPref}, ${mainMax}px)`);
    root.setProperty("--btn-size", `clamp(${btnMin}px, ${btnPref}px, ${btnMax}px)`);
    root.setProperty("--btn-icon-size", `clamp(${iconMin}px, ${iconPref}px, ${iconMax}px)`);
  }
  window.addEventListener("resize", () => { updateLayoutVars(); render(); });
  window.addEventListener("orientationchange", () => { updateLayoutVars(); render(); });

  function render(){
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth()+1;
    const d = now.getDate();
    const dow = now.getDay();

    yearEl.textContent = `ä»¤å’Œ${y-2018}å¹´ ${y}`;

    // âœ… æ—¥ä»˜ã¨æ›œæ—¥ã‚’åˆ†å‰²è¡¨ç¤ºï¼ˆå¼·èª¿ã‚’åˆ¥ã€…ã«ã§ãã‚‹ï¼‰
    // âœ… ï¼ˆ ï¼‰ã ã‘0.8å€ã€(æœˆ)ã¯å°‘ã—é›¢ã™ã€wbrã§æ”¹è¡Œå¯èƒ½
    dateEl.innerHTML =
      `<span class="${dayClass(dow)}">
        <span class="dateMain">${m}<span class="unit">æœˆ</span>${d}<span class="unit">æ—¥</span></span><wbr>
        <span class="dowGap dateWeek"><span class="paren">ï¼ˆ</span>${wd[dow]}<span class="paren">ï¼‰</span></span>
       </span>`;

    timeEl.textContent = `${pad(now.getHours())}ï¼š${pad(now.getMinutes())}`;

    // ã¯ã¿å‡ºã—å¯¾ç­–ï¼ˆå¹´ãƒ»æ—¥ä»˜ãƒ»æ™‚åˆ»ï¼‰
    fitToWidth(yearEl);
    fitToWidth(dateEl);
    fitToWidth(timeEl);

    checkAutoSpeak(now);
  }

  function ensureAudioContext(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === "suspended"){
      return audioCtx.resume().catch(()=>{});
    }
    return Promise.resolve();
  }

  function playChime(){
    if(!audioCtx) return Promise.resolve();

    const t = audioCtx.currentTime;
    const g = audioCtx.createGain();
    g.connect(audioCtx.destination);

    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(0.30,t+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,t+0.45);

    const o = audioCtx.createOscillator();
    o.type="triangle";
    o.frequency.setValueAtTime(1200,t);
    o.frequency.exponentialRampToValueAtTime(600,t+0.4);
    o.connect(g);

    o.start(t);
    o.stop(t+0.45);

    return new Promise(res => setTimeout(res, 470));
  }

  function refreshVoices(){
    if(!("speechSynthesis" in window)) return;
    const voices = speechSynthesis.getVoices() || [];
    const ja = voices.filter(v => (v.lang || "").toLowerCase().startsWith("ja"));
    preferredVoice = ja[0] || null;
  }
  if("speechSynthesis" in window){
    speechSynthesis.onvoiceschanged = refreshVoices;
  }

  function makeUtterance(text){
    const u = new SpeechSynthesisUtterance(text);
    u.lang="ja-JP";
    u.rate=0.9;
    u.pitch=1.2;
    u.volume=1;
    if(preferredVoice) u.voice = preferredVoice;
    return u;
  }

  // iOSä¿é™ºï¼šæ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
  function speakUtteranceSafe(u, fallbackMs = 6500){
    return new Promise(resolve=>{
      let finished = false;
      const finish = () => {
        if(finished) return;
        finished = true;
        resolve();
      };
      u.onend = finish;
      u.onerror = finish;
      setTimeout(finish, fallbackMs);

      try { speechSynthesis.resume(); } catch(e) {}
      try { speechSynthesis.speak(u); } catch(e) { finish(); }
    });
  }

  function clearFocus(){
    yearEl.classList.remove("focus");
    dateEl.classList.remove("focus");
    timeEl.classList.remove("focus");

    const dm = dateEl.querySelector(".dateMain");
    const dw = dateEl.querySelector(".dateWeek");
    if(dm) dm.classList.remove("focus");
    if(dw) dw.classList.remove("focus");
  }

  function focusDateMain(){
    clearFocus();
    const dm = dateEl.querySelector(".dateMain");
    if(dm){
      dm.classList.add("focus");
      // inlineã§ã‚‚åŠ¹ãã‚ˆã†ã«
      dm.style.display = "inline-block";
      dm.style.transform = `scale(var(--focus-scale))`;
      dm.style.transition = "transform 0.22s ease";
    }
  }

  function focusDateWeek(){
    clearFocus();
    const dw = dateEl.querySelector(".dateWeek");
    if(dw){
      dw.classList.add("focus");
      dw.style.display = "inline-block";
      dw.style.transform = `scale(var(--focus-scale))`;
      dw.style.transition = "transform 0.22s ease";
    }
  }

  function focusTime(){
    clearFocus();
    timeEl.classList.add("focus");
  }

  function focusYear(){
    clearFocus();
    yearEl.classList.add("focus");
  }

  function timeGreeting(h){
    if(h===7)  return "æœã§ã™ã€‚";
    if(h===12) return "ãŠæ˜¼ã§ã™ã€‚";
    if(h===18) return "å¤•æ–¹ã§ã™ã€‚";
    return "";
  }

  function buildParts(now){
    const y = now.getFullYear();
    const m = now.getMonth()+1;
    const d = now.getDate();
    const dow = wd[now.getDay()];
    const h = now.getHours();
    const min = now.getMinutes();

    return {
      // âœ… æ—¥ä»˜ã¨æ›œæ—¥ã‚’åˆ†ã‘ã¦èª­ã¿ä¸Šã’ï¼ˆå¼·èª¿ã‚‚å®Œå…¨åŒæœŸï¼‰
      dateOnly: `ä»Šæ—¥ã¯${m}æœˆ${d}æ—¥ã§ã™ã€‚`,
      weekdayOnly: `${dow}æ›œæ—¥ã§ã™ã€‚`,
      time: `æ™‚åˆ»ã¯${h}æ™‚${min}åˆ†ã§ã™ã€‚`,
      year: `ä»¤å’Œ${y-2018}å¹´ã€${y}å¹´ã§ã™ã€‚`,
      greet: timeGreeting(h)
    };
  }

  async function runGate(){
    if(speaking) return;
    speaking = true;
    gateBtn.disabled = true;

    try{
      await ensureAudioContext();
      refreshVoices();

      // â‘¤ã®æ¼”å‡ºï¼šã‚¹ã‚¤ãƒƒãƒONã®éŸ³å£°ï¼ˆé¢ç™½ã¿ï¼‹ç›®çš„ï¼‰
      await playChime();
      try { speechSynthesis.cancel(); } catch(e) {}
      await speakUtteranceSafe(makeUtterance("ã‚¹ã‚¤ãƒƒãƒã‚ªãƒ³ï¼ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚"), 4500);

      // æœ¬ä½“ã¸
      ttsReady = true;
      gate.style.display = "none";
      app.style.visibility = "visible";
      render();

    } finally {
      speaking = false;
      gateBtn.disabled = false;
    }
  }

  async function speakSequence(now){
    if(speaking) return;
    speaking = true;
    speakBtn.disabled = true;

    try{
      refreshVoices();
      try { speechSynthesis.cancel(); } catch(e) {}
      try { speechSynthesis.resume(); } catch(e) {}

      const p = buildParts(now);

      // âœ… ã€Œä»Šæ—¥ã¯â€¦ã€ï¼šæ—¥ä»˜ï¼ˆæ•°å­—ï¼‹æœˆæ—¥ï¼‰ã ã‘å¼·èª¿
      focusDateMain();
      await playChime();
      await speakUtteranceSafe(makeUtterance(p.greet + p.dateOnly), 6500);

      // âœ… ã€Œæ›œæ—¥â€¦ã€ï¼šæ›œæ—¥ã ã‘å¼·èª¿
      focusDateWeek();
      await playChime();
      await speakUtteranceSafe(makeUtterance(p.weekdayOnly), 4500);

      // âœ… ã€Œæ™‚åˆ»ã¯â€¦ã€ï¼šæ™‚åˆ»ã ã‘å¼·èª¿
      focusTime();
      await playChime();
      await speakUtteranceSafe(makeUtterance(p.time), 6500);

      // âœ… ã€Œä»¤å’Œâ€¦ã€ï¼šå¹´ã ã‘å¼·èª¿
      focusYear();
      await playChime();
      await speakUtteranceSafe(makeUtterance(p.year), 5200);

    } finally {
      clearFocus();
      speaking = false;
      speakBtn.disabled = false;
    }
  }

  async function manualSpeak(){
    if(!ttsReady) return; // ã‚²ãƒ¼ãƒˆæœªé€šéãªã‚‰ç„¡åŠ¹
    await ensureAudioContext();
    await speakSequence(new Date());
  }

  function checkAutoSpeak(now){
    if(!ttsReady) return;
    if(now.getMinutes() !== 0) return;
    if(!AUTO_HOURS.includes(now.getHours())) return;

    const key = `${now.toDateString()}-${now.getHours()}`;
    if(key === lastAutoKey) return;
    lastAutoKey = key;

    if(document.visibilityState !== "visible") return;
    speakSequence(now);
  }

  // åˆæœŸåŒ–
  updateLayoutVars();
  refreshVoices();
  render(); // gateä¸­ã§ã‚‚è¡¨ç¤ºæº–å‚™ã¯ã—ã¦ãŠãï¼ˆæœ¬ä½“ã¯éè¡¨ç¤ºï¼‰

  // åˆ†ãŒå¤‰ã‚ã‚‹ç¬é–“ã«æ›´æ–°
  (function tick(){
    const n = new Date();
    setTimeout(()=>{ render(); tick(); },
      (60-n.getSeconds())*1000 - n.getMilliseconds()+30);
  })();
</script>
</body>
</html>
