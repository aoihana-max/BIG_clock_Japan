<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>BIGã‚«ãƒ¬ãƒ³ãƒ€</title>

  <style>
    :root{
      --bg:#000000;

      --year:#FFFFFF;
      --wk:#FFFF00;
      --sat:#5FB3E6;
      --sun:#FF4A4A;

      --time:#00ff00;

      --btn-bg:#ff8c00;
      --btn-bg-press:#C96A2C;
      --btn-ring:#C96A2C;
      --btn-disabled:#5A3A28;
      --btn-icon:#FFF1E6;
      --btn-icon-disabled:#D9B9A2;

      /* å¼·èª¿ï¼šç™ºå…‰ãªã—ãƒ»æ‹¡å¤§ã®ã¿ */
      --dim-scale: 0.92;
      --focus-scale: 1.18;

      /* âœ… æ—¥ä»˜ã¨æ›œæ—¥ã®é–“ã®ã€Œè¦‹ãŸç›®ã®ç©ºç™½ã€ã‚’ãªãã™ */
      --dow-gap: 0em;
    }

    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      font-family:-apple-system,"BIZ UDPGothic","Meiryo",sans-serif;
      overflow:hidden;
    }

    .wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      padding: max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right))
               max(14px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));
      gap: 3.6vmin;
      box-sizing:border-box;
    }

    :root{
      --year-font: clamp(34px, 7.2vmin, 96px);
      --main-font: clamp(52px, 12.5vmin, 160px);
      --btn-size: clamp(76px, 10vmin, 138px);
      --btn-icon-size: clamp(40px, 6vmin, 76px);
    }

    .yearline{
      color:var(--year);
      font-weight:900;
      font-size: var(--year-font);
      white-space:nowrap;
      max-width: 96vw;
    }

    .dateline{
      font-weight:950;
      font-size: var(--main-font);
      white-space:nowrap;
      max-width: 96vw;
    }

    /* âœ… æœˆ/æ—¥ ã¨ ï¼ˆ ï¼‰ã‚’åŒã˜ã‚µã‚¤ã‚ºã«ã™ã‚‹ï¼š0.6em */
    .unit{
      font-size:0.6em;
      margin:0;
    }

    /* æ—¥ä»˜ã¨æ›œæ—¥ã®é–“ã¯è¦‹ãŸç›®ã®ç©ºç™½ãªã— */
    .dow{
      margin-left: var(--dow-gap);
    }

    .timeRow{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 3vmin;
      max-width: 96vw;
      white-space:nowrap;
    }
    @media (orientation: portrait){
      .timeRow{ flex-direction:column; gap: 2.2vmin; }
    }

    .timeline{
      color:var(--time);
      font-weight:950;
      font-size: var(--main-font);
      white-space:nowrap;
      max-width: 96vw;
    }

    .wk{color:var(--wk);}
    .sat{color:var(--sat);}
    .sun{color:var(--sun);}

    .speakBtn{
      width: var(--btn-size);
      height: var(--btn-size);
      border-radius:9999px;
      border: 5px solid var(--btn-ring);
      background: var(--btn-bg);
      color: var(--btn-icon);

      display:flex;
      align-items:center;
      justify-content:center;

      font-size: var(--btn-icon-size);
      font-weight:900;

      box-shadow:0 10px 18px rgba(0,0,0,0.45);

      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      cursor:pointer;
    }
    .speakBtn:active{ background: var(--btn-bg-press); transform: translateY(3px); }
    .speakBtn[disabled]{
      background: var(--btn-disabled);
      color: var(--btn-icon-disabled);
      border-color:#8C5A3C;
      box-shadow:none;
      cursor:default;
    }

    /* âœ… å¼·èª¿ï¼ˆæ‹¡å¤§ã®ã¿ï¼‰ */
    .emph{
      transition: transform 0.22s ease;
      transform: scale(var(--dim-scale));
    }
    .emph.focus{
      transform: scale(var(--focus-scale));
    }

    /* âœ… æ—¥ä»˜å†…ã®éƒ¨åˆ†å¼·èª¿ï¼ˆâ€œå…¨éƒ¨æ‹¡å¤§â€ã‚’é¿ã‘ã‚‹ãŸã‚åˆ†å‰²ï¼‰ */
    .datePart{
      display:inline-block; /* transformãŒåŠ¹ã */
      transition: transform 0.22s ease;
      transform: scale(1);  /* é€šå¸¸ */
    }
    .datePart.focusPart{
      transform: scale(var(--focus-scale));
    }

    /* è¨ºæ–­è¡¨ç¤º */
    .diag{
      position: fixed;
      left: 10px;
      right: 10px;
      bottom: 10px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 10px 12px;
      color: #fff;
      font-size: 12px;
      line-height: 1.35;
      max-height: 22vh;
      overflow: auto;
      user-select: text;
      z-index: 9999;
    }
    .diag strong{ font-weight: 800; }
    .diag .row{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:6px; align-items:center; }
    .diag button{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color:#fff;
    }

    /* è¨ºæ–­ã‚’ç›®ç«‹ãŸãªã„ãƒœã‚¿ãƒ³ã§éš ã™ */
    .diagHideBtn{
      margin-left:auto;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 10px;
      opacity: 0.65;
    }

    /* è¨ºæ–­å¾©å¸°ãƒœã‚¿ãƒ³ */
    .diagShowFloating{
      position: fixed;
      right: 10px;
      bottom: 10px;
      z-index: 10000;
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: #fff;
      opacity: 0.55;
      display: none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
    }
    .diagShowFloating:active{ opacity: 0.8; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="yearline emph" id="yearline">----</div>
    <div class="dateline emph" id="dateline">----</div>

    <div class="timeRow">
      <div class="timeline emph" id="timeline">--ï¼š--</div>
      <button class="speakBtn" id="speakBtn" onclick="manualSpeak()" ontouchstart="manualSpeak()">ğŸ”Š</button>
    </div>
  </div>

  <div class="diag" id="diag">
    <div class="row">
      <strong>è¨ºæ–­</strong>
      <button onclick="testSpeech()">éŸ³å£°ãƒ†ã‚¹ãƒˆ</button>
      <button onclick="refreshVoices()">éŸ³å£°ä¸€è¦§æ›´æ–°</button>
      <button class="diagHideBtn" onclick="hideDiag()">éš ã™</button>
    </div>
    <div id="diagText">èµ·å‹•ã—ã¾ã—ãŸã€‚</div>
  </div>

  <button class="diagShowFloating" id="diagShowBtn" onclick="showDiag()">è¨º</button>

<script>
  const yearEl = document.getElementById("yearline");
  const dateEl = document.getElementById("dateline");
  const timeEl = document.getElementById("timeline");
  const speakBtn = document.getElementById("speakBtn");
  const diagText = document.getElementById("diagText");

  const diag = document.getElementById("diag");
  const diagShowBtn = document.getElementById("diagShowBtn");

  const wd = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  const AUTO_HOURS = [7, 12, 18];

  let speaking = false;
  let lastAutoKey = "";

  let userActivatedAudio = false;
  let audioCtx = null;

  let cachedVoices = [];
  let preferredVoice = null;

  const pad = n => String(n).padStart(2,"0");
  function dayClass(d){ return d===0 ? "sun" : d===6 ? "sat" : "wk"; }

  function log(msg){
    const t = new Date();
    const stamp = `${pad(t.getHours())}:${pad(t.getMinutes())}:${pad(t.getSeconds())}`;
    diagText.innerHTML = `${stamp} ${msg}<br>` + diagText.innerHTML;
  }

  function hideDiag(){
    diag.style.display = "none";
    diagShowBtn.style.display = "block";
  }
  function showDiag(){
    diag.style.display = "block";
    diagShowBtn.style.display = "none";
  }

  function updateLayoutVars(){
    const w = window.innerWidth;
    const h = window.innerHeight;
    const vmin = Math.min(w, h);
    const isLandscape = w > h;
    const mult = isLandscape ? 1.2 : 1.0;

    const yearMin = Math.max(28, Math.floor(vmin * 0.085 * mult));
    const yearPref = (vmin * 0.11 * mult).toFixed(2) + "px";
    const yearMax = Math.max(72, Math.floor(vmin * 0.20 * mult));

    const mainMin = Math.max(40, Math.floor(vmin * 0.13 * mult));
    const mainPref = (vmin * 0.19 * mult).toFixed(2) + "px";
    const mainMax = Math.max(110, Math.floor(vmin * 0.34 * mult));

    const btnMin = Math.max(60, Math.floor(vmin * 0.14 * mult));
    const btnPref = Math.max(72, Math.floor(vmin * 0.16 * mult));
    const btnMax = Math.max(110, Math.floor(vmin * 0.22 * mult));

    const iconMin = Math.max(32, Math.floor(vmin * 0.085 * mult));
    const iconPref = Math.max(40, Math.floor(vmin * 0.095 * mult));
    const iconMax = Math.max(64, Math.floor(vmin * 0.13 * mult));

    const root = document.documentElement.style;
    root.setProperty("--year-font", `clamp(${yearMin}px, ${yearPref}, ${yearMax}px)`);
    root.setProperty("--main-font", `clamp(${mainMin}px, ${mainPref}, ${mainMax}px)`);
    root.setProperty("--btn-size", `clamp(${btnMin}px, ${btnPref}, ${btnMax}px)`);
    root.setProperty("--btn-icon-size", `clamp(${iconMin}px, ${iconPref}, ${iconMax}px)`);
  }
  window.addEventListener("resize", updateLayoutVars);
  window.addEventListener("orientationchange", updateLayoutVars);

  /* âœ… æ—¥ä»˜ã‚’ã€Œæœˆæ—¥ãƒ‘ãƒ¼ãƒˆã€ã¨ã€Œæ›œæ—¥ãƒ‘ãƒ¼ãƒˆã€ã«åˆ†å‰²ã—ã¦æç”» */
  function render(){
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth()+1;
    const d = now.getDate();
    const dow = now.getDay();

    yearEl.textContent = `ä»¤å’Œ${y-2018}å¹´ ${y}`;

    // ä¾‹ï¼‰10æœˆ12æ—¥(ç¥ï½¥æœˆ) ãªã©æ–‡å­—æ•°ãŒå¢—ãˆã¦ã‚‚
    // â€œå…¨ä½“æ‹¡å¤§â€ã‚’é¿ã‘ã¦è¦‹åˆ‡ã‚Œã‚’æ¸›ã‚‰ã™ãŸã‚ã€æœˆæ—¥/æ›œæ—¥ã‚’åˆ†å‰²
    dateEl.innerHTML =
      `<span class="${dayClass(dow)}">
         <span class="datePart" id="dateMD">${m}<span class="unit">æœˆ</span>${d}<span class="unit">æ—¥</span></span><span class="dow datePart" id="dateDOW"><span class="unit">(</span>${wd[dow]}<span class="unit">)</span></span>
       </span>`;

    timeEl.textContent = `${pad(now.getHours())}ï¼š${pad(now.getMinutes())}`;

    checkAutoSpeak(now);
  }

  function ensureAudioContext(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      log("AudioContext ä½œæˆ");
    }
    if(audioCtx.state === "suspended"){
      log("AudioContext resume è©¦è¡Œ");
      return audioCtx.resume().catch(()=>{ log("AudioContext resume å¤±æ•—"); });
    }
    return Promise.resolve();
  }

  function playChime(){
    if(!audioCtx) return Promise.resolve();

    const t = audioCtx.currentTime;
    const g = audioCtx.createGain();
    g.connect(audioCtx.destination);

    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(0.30,t+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,t+0.45);

    const o = audioCtx.createOscillator();
    o.type="triangle";
    o.frequency.setValueAtTime(1200,t);
    o.frequency.exponentialRampToValueAtTime(600,t+0.4);
    o.connect(g);

    o.start(t);
    o.stop(t+0.45);

    return new Promise(res => setTimeout(res, 470));
  }

  /* âœ… å¼·èª¿è§£é™¤ï¼ˆå…¨ãƒ‘ãƒ¼ãƒˆï¼‰ */
  function clearFocusAll(){
    yearEl.classList.remove("focus");
    dateEl.classList.remove("focus");
    timeEl.classList.remove("focus");

    const md = document.getElementById("dateMD");
    const dw = document.getElementById("dateDOW");
    if(md) md.classList.remove("focusPart");
    if(dw) dw.classList.remove("focusPart");
  }

  function focusMonthDay(){
    clearFocusAll();
    const md = document.getElementById("dateMD");
    if(md) md.classList.add("focusPart");
  }

  function focusWeekday(){
    clearFocusAll();
    const dw = document.getElementById("dateDOW");
    if(dw) dw.classList.add("focusPart");
  }

  function focusTime(){
    clearFocusAll();
    timeEl.classList.add("focus");
  }

  function focusYear(){
    clearFocusAll();
    yearEl.classList.add("focus");
  }

  function timeGreeting(h){
    if(h===7)  return "æœã§ã™ã€‚";
    if(h===12) return "ãŠæ˜¼ã§ã™ã€‚";
    if(h===18) return "å¤•æ–¹ã§ã™ã€‚";
    return "";
  }

  /* âœ… èª­ã¿ä¸Šã’ã‚‚ â€œæœˆæ—¥â†’æ›œæ—¥â†’æ™‚åˆ»â†’å¹´â€ ã®é †ã«åˆ†å‰² */
  function buildParts(now){
    const y = now.getFullYear();
    const m = now.getMonth()+1;
    const d = now.getDate();
    const dow = wd[now.getDay()];
    const h = now.getHours();
    const min = now.getMinutes();

    return {
      greet: timeGreeting(h),
      partMD: `ä»Šæ—¥ã¯${m}æœˆ${d}æ—¥ã§ã™ã€‚`,
      partDOW: `${dow}æ›œæ—¥ã§ã™ã€‚`,
      partTIME: `æ™‚åˆ»ã¯${h}æ™‚${min}åˆ†ã§ã™ã€‚`,
      partYEAR: `ä»¤å’Œ${y-2018}å¹´ã€${y}å¹´ã§ã™ã€‚`
    };
  }

  function refreshVoices(){
    if(!("speechSynthesis" in window)){
      log("speechSynthesis ãªã—ï¼ˆã“ã®ç’°å¢ƒã§ã¯éŸ³å£°ä¸å¯ï¼‰");
      return;
    }
    cachedVoices = speechSynthesis.getVoices() || [];
    const ja = cachedVoices.filter(v => (v.lang || "").toLowerCase().startsWith("ja"));
    preferredVoice = ja[0] || null;
    log(`éŸ³å£°ä¸€è¦§: total=${cachedVoices.length}, ja=${ja.length}${preferredVoice ? " / ja[0]="+preferredVoice.name : ""}`);
  }

  if("speechSynthesis" in window){
    speechSynthesis.onvoiceschanged = () => {
      refreshVoices();
    };
  }

  function makeUtterance(text){
    const u = new SpeechSynthesisUtterance(text);
    u.lang="ja-JP";
    u.rate=0.9;
    u.pitch=1.2;
    u.volume=1;
    if(preferredVoice) u.voice = preferredVoice;
    return u;
  }

  function speakUtteranceSafe(u, fallbackMs = 6500){
    return new Promise(resolve=>{
      let finished = false;
      const finish = (why) => {
        if(finished) return;
        finished = true;
        if(why) log(why);
        resolve();
      };

      u.onstart = () => log("TTS start");
      u.onend = () => finish("TTS end");
      u.onerror = () => finish("TTS error");

      const timer = setTimeout(() => finish("TTS timeoutï¼ˆç„¡éŸ³/ç„¡åå¿œã®å¯èƒ½æ€§ï¼‰"), fallbackMs);

      try { speechSynthesis.cancel(); } catch(e) {}
      try { speechSynthesis.resume(); } catch(e) {}

      setTimeout(() => {
        try { speechSynthesis.resume(); } catch(e) {}
        try { speechSynthesis.speak(u); } catch(e) { finish("TTS speak throw"); }
      }, 180);

      const origResolve = resolve;
      resolve = () => { clearTimeout(timer); origResolve(); };
    });
  }

  async function speakSequence(now){
    if(speaking) return;
    speaking = true;
    speakBtn.disabled = true;

    try{
      if(!("speechSynthesis" in window)){
        log("speechSynthesis ãŒä½¿ãˆã¾ã›ã‚“");
        return;
      }

      refreshVoices();
      const p = buildParts(now);

      // âœ… æœˆæ—¥ â†’ æ›œæ—¥ â†’ æ™‚åˆ» â†’ å¹´ ã®å¼·èª¿ã¨èª­ã¿ä¸Šã’
      focusMonthDay(); await playChime(); await speakUtteranceSafe(makeUtterance(p.greet + p.partMD), 4500);
      focusWeekday();  await playChime(); await speakUtteranceSafe(makeUtterance(p.partDOW), 3500);
      focusTime();     await playChime(); await speakUtteranceSafe(makeUtterance(p.partTIME), 5500);
      focusYear();     await playChime(); await speakUtteranceSafe(makeUtterance(p.partYEAR), 4500);

    } finally {
      clearFocusAll();
      speaking = false;
      speakBtn.disabled = false;
    }
  }

  async function manualSpeak(){
    if(speaking) return;
    userActivatedAudio = true;

    await ensureAudioContext();
    refreshVoices();
    log("æ‰‹å‹•èª­ã¿ä¸Šã’é–‹å§‹");
    await speakSequence(new Date());
  }

  function checkAutoSpeak(now){
    if(now.getMinutes() !== 0) return;
    if(!AUTO_HOURS.includes(now.getHours())) return;

    const key = `${now.toDateString()}-${now.getHours()}`;
    if(key === lastAutoKey) return;
    lastAutoKey = key;

    if(!userActivatedAudio) return;
    if(document.visibilityState !== "visible") return;

    speakSequence(now);
  }

  async function testSpeech(){
    userActivatedAudio = true;
    await ensureAudioContext();

    refreshVoices();
    log("éŸ³å£°ãƒ†ã‚¹ãƒˆï¼šé–‹å§‹ï¼ˆã€ãƒãƒ­ãƒ¼ã€ï¼‰");
    try{
      await speakUtteranceSafe(makeUtterance("ãƒãƒ­ãƒ¼"), 4500);
    } finally {
      log("éŸ³å£°ãƒ†ã‚¹ãƒˆï¼šçµ‚äº†");
    }
  }

  updateLayoutVars();
  render();
  refreshVoices();

  (function tick(){
    const n = new Date();
    setTimeout(()=>{ render(); tick(); },
      (60-n.getSeconds())*1000 - n.getMilliseconds()+30);
  })();
</script>
</body>
</html>
