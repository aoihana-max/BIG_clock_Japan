<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ä»Šæ—¥ã®æ—¥æ™‚</title>

<style>
/*************************************************
 * ğŸ¨ è‰²ï¼ˆãã®ã¾ã¾ï¼‰
 *************************************************/
:root{
  --bg:#000000;

  --year:#FFFFFF;

  --wk:#FFFF00;
  --sat:#5FB3E6;
  --sun:#FF4A4A;

  --time:#00ff00;

  --btn-bg:#ff8c00;
  --btn-bg-press:#C96A2C;
  --btn-ring:#C96A2C;
  --btn-disabled:#5A3A28;

  --btn-icon:#FFF1E6;
  --btn-icon-disabled:#D9B9A2;

  /*************************************************
   * ğŸ“ è‡ªå‹•ãƒªã‚µã‚¤ã‚ºï¼ˆã“ã“ãŒè‚ï¼‰
   * vmin = ç”»é¢ã®çŸ­ã„è¾ºã«é€£å‹•
   *************************************************/
  --year-font: clamp(36px, 7.5vmin, 96px);
  --main-font: clamp(56px, 12.5vmin, 160px);  /* æ—¥ä»˜ãƒ»æ™‚åˆ»ã®åŸºæº– */
  --btn-size:  clamp(78px, 10vmin, 140px);
  --btn-icon-size: clamp(42px, 6vmin, 78px);

  /*************************************************
   * ğŸ” å¼·èª¿ï¼ˆæ‹¡å¤§ã®ã¿ï¼‰
   *************************************************/
  --dim-scale: 0.92;
  --focus-scale: 1.18;
}

/*************************************************
 * ğŸ§± ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå…±é€š
 *************************************************/
html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  font-family:-apple-system,"BIZ UDPGothic","Meiryo",sans-serif;
  overflow:hidden;
}

.wrap{
  height:100%;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;

  /* ä½™ç™½ã¯å°‘ã—ã ã‘ç¢ºä¿ï¼ˆã¯ã¿å‡ºã—é˜²æ­¢ï¼‰ */
  padding: max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right))
           max(14px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));
  gap: 3.5vmin;
  box-sizing:border-box;
}

/*************************************************
 * ğŸ”  æ–‡å­—
 *************************************************/
.yearline{
  color:var(--year);
  font-weight:900;
  font-size: var(--year-font);
  white-space:nowrap;
  max-width: 96vw;
}

.dateline{
  font-weight:950;
  font-size: var(--main-font);
  white-space:nowrap;
  max-width: 96vw;
}

/* æœˆãƒ»æ—¥ï¼ˆå˜ä½ï¼‰ã ã‘å°ã•ã */
.unit{ font-size:0.6em; margin:0; }

.timeline{
  color:var(--time);
  font-weight:950;
  font-size: var(--main-font);
  white-space:nowrap;
  max-width: 96vw;
}

/* æ›œæ—¥è‰² */
.wk{color:var(--wk);}
.sat{color:var(--sat);}
.sun{color:var(--sun);}

/*************************************************
 * â± æ™‚åˆ»è¡Œï¼ˆæ¨ªå‘ãã¯æ¨ªä¸¦ã³ã€ç¸¦å‘ãã¯ç¸¦ä¸¦ã³ã«åˆ‡æ›¿ï¼‰
 *************************************************/
.timeRow{
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 3vmin;
  max-width: 96vw;
}

/* âœ… ç¸¦å‘ãã¯ â€œç¸¦ä¸¦ã³â€ ã«ã—ã¦ã¯ã¿å‡ºã—å›é¿ */
@media (orientation: portrait){
  .timeRow{
    flex-direction:column;
    gap: 2vmin;
  }
}

/*************************************************
 * ğŸ”Š ãƒœã‚¿ãƒ³
 *************************************************/
.speakBtn{
  width: var(--btn-size);
  height: var(--btn-size);
  border-radius:9999px;

  border: 5px solid var(--btn-ring);
  background: var(--btn-bg);
  color: var(--btn-icon);

  display:flex;
  align-items:center;
  justify-content:center;

  font-size: var(--btn-icon-size);
  font-weight:900;

  box-shadow:0 10px 18px rgba(0,0,0,0.45);
  cursor:pointer;
}

.speakBtn:active{
  background:var(--btn-bg-press);
  transform:translateY(3px);
}

.speakBtn[disabled]{
  background:var(--btn-disabled);
  color:var(--btn-icon-disabled);
  border-color:#8C5A3C;
  box-shadow:none;
  cursor:default;
}

/*************************************************
 * âœ… å¼·èª¿ï¼ˆç™ºå…‰ãªã—ï¼æ‹¡å¤§ã®ã¿ï¼‰
 *************************************************/
.emph{
  transition: transform 0.22s ease;
  transform: scale(var(--dim-scale));
}
.emph.focus{
  transform: scale(var(--focus-scale));
}
</style>
</head>

<body>
<div class="wrap">
  <div class="yearline emph" id="yearline">----</div>
  <div class="dateline emph" id="dateline">----</div>

  <div class="timeRow">
    <div class="timeline emph" id="timeline">--ï¼š--</div>
    <button class="speakBtn" id="speakBtn" onclick="manualSpeak()">ğŸ”Š</button>
  </div>
</div>

<script>
const yearEl = document.getElementById("yearline");
const dateEl = document.getElementById("dateline");
const timeEl = document.getElementById("timeline");
const speakBtn = document.getElementById("speakBtn");

const wd = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];

/* âœ… è‡ªå‹•èª­ã¿ä¸Šã’ï¼š7 / 12 / 18 */
const AUTO_HOURS = [7, 12, 18];

let speaking = false;
let lastAutoKey = "";

/* iOSå®‰å®šåŒ–ï¼šä¸€åº¦ã§ã‚‚æ‰‹å‹•ã‚¿ãƒƒãƒ—ã—ãŸã‚‰è‡ªå‹•ã‚’è¨±å¯ */
let userActivatedAudio = false;
let audioCtx = null;

const pad = n => String(n).padStart(2,"0");
function dayClass(d){ return d===0 ? "sun" : d===6 ? "sat" : "wk"; }

/* ===== è¡¨ç¤ºæ›´æ–°ï¼ˆç©ºç™½ãŒå‡ºãªã„1è¡Œï¼‰ ===== */
function render(){
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth()+1;
  const d = now.getDate();
  const dow = now.getDay();

  yearEl.textContent = `ä»¤å’Œ${y-2018}å¹´ ${y}`;
  dateEl.innerHTML = `<span class="${dayClass(dow)}">${m}<span class="unit">æœˆ</span>${d}<span class="unit">æ—¥</span>(${wd[dow]})</span>`;
  timeEl.textContent = `${pad(now.getHours())}ï¼š${pad(now.getMinutes())}`;

  checkAutoSpeak(now);
}

/* ===== AudioContextï¼ˆæ‰‹å‹•ã‚¿ãƒƒãƒ—ã§èµ·å‹•ï¼‰ ===== */
function ensureAudioContext(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === "suspended") return audioCtx.resume().catch(()=>{});
  return Promise.resolve();
}

/* ===== åŠ¹æœéŸ³ï¼ˆå„ãƒ‘ãƒ¼ãƒˆç›´å‰ã«é³´ã‚‰ã™ï¼‰ ===== */
function playChime(){
  if(!audioCtx) return Promise.resolve();

  const t = audioCtx.currentTime;
  const g = audioCtx.createGain();
  g.connect(audioCtx.destination);

  g.gain.setValueAtTime(0.0001,t);
  g.gain.exponentialRampToValueAtTime(0.30,t+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001,t+0.45);

  const o = audioCtx.createOscillator();
  o.type="triangle";
  o.frequency.setValueAtTime(1200,t);
  o.frequency.exponentialRampToValueAtTime(600,t+0.4);
  o.connect(g);

  o.start(t);
  o.stop(t+0.45);

  return new Promise(res => setTimeout(res, 470));
}

/* ===== å¼·èª¿ ===== */
function clearFocus(){
  yearEl.classList.remove("focus");
  dateEl.classList.remove("focus");
  timeEl.classList.remove("focus");
}
function focusDate(){ clearFocus(); dateEl.classList.add("focus"); }
function focusTime(){ clearFocus(); timeEl.classList.add("focus"); }
function focusYear(){ clearFocus(); yearEl.classList.add("focus"); }

/* ===== èª­ã¿ä¸Šã’æ–‡ ===== */
function timeGreeting(h){
  if(h===7)  return "æœã§ã™ã€‚";
  if(h===12) return "ãŠæ˜¼ã§ã™ã€‚";
  if(h===18) return "å¤•æ–¹ã§ã™ã€‚";
  return "";
}

function buildParts(now){
  const y = now.getFullYear();
  const m = now.getMonth()+1;
  const d = now.getDate();
  const dow = wd[now.getDay()];
  const h = now.getHours();
  const min = now.getMinutes();

  return {
    part1: `ä»Šæ—¥ã¯${m}æœˆ${d}æ—¥${dow}æ›œæ—¥ã§ã™ã€‚`,
    part2: `æ™‚åˆ»ã¯${h}æ™‚${min}åˆ†ã§ã™ã€‚`,
    part3: `ä»¤å’Œ${y-2018}å¹´ã€${y}å¹´ã§ã™ã€‚`
  };
}

function makeUtterance(text){
  const u = new SpeechSynthesisUtterance(text);
  u.lang="ja-JP";
  u.rate=0.9;
  u.pitch=1.2;
  return u;
}

function speakUtterance(u){
  return new Promise(resolve=>{
    u.onend = resolve;
    u.onerror = resolve;
    speechSynthesis.speak(u);
  });
}

/* ===== 3æ®µéšï¼šå„ãƒ‘ãƒ¼ãƒˆç›´å‰ã«åŠ¹æœéŸ³ â†’ èª­ã¿ä¸Šã’ ===== */
async function speakSequence(now){
  if(speaking) return;
  speaking = true;
  speakBtn.disabled = true;

  const greet = timeGreeting(now.getHours());
  const { part1, part2, part3 } = buildParts(now);

  speechSynthesis.cancel();

  // â‘  æ—¥ä»˜
  focusDate();
  await playChime();
  await speakUtterance(makeUtterance(greet + part1));

  // â‘¡ æ™‚åˆ»
  focusTime();
  await playChime();
  await speakUtterance(makeUtterance(part2));

  // â‘¢ å¹´
  focusYear();
  await playChime();
  await speakUtterance(makeUtterance(part3));

  clearFocus();
  speaking = false;
  speakBtn.disabled = false;
}

/* æ‰‹å‹• */
async function manualSpeak(){
  userActivatedAudio = true;
  await ensureAudioContext();
  await speakSequence(new Date());
}

/* è‡ªå‹•ï¼ˆæ‰‹å‹•1å›å¾Œã«ã®ã¿å‹•ä½œï¼‰ */
function checkAutoSpeak(now){
  if(now.getMinutes() !== 0) return;
  if(!AUTO_HOURS.includes(now.getHours())) return;

  const key = `${now.toDateString()}-${now.getHours()}`;
  if(key === lastAutoKey) return;
  lastAutoKey = key;

  if(!userActivatedAudio) return;
  if(document.visibilityState !== "visible") return;

  speakSequence(now);
}

/* åˆæœŸåŒ– & åˆ†æ›´æ–° */
render();
(function tick(){
  const n = new Date();
  setTimeout(()=>{ render(); tick(); },
    (60-n.getSeconds())*1000 - n.getMilliseconds()+30);
})();
</script>
</body>
</html>
